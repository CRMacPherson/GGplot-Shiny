---
title: "ggPlot Your Data (2.0)"
output: html_document
runtime: shiny
#css: style.css
---


```{r, echo=FALSE ,warning=FALSE,error=FALSE }

suppressMessages (library(shiny))
suppressMessages (library(ggplot2))
suppressMessages (library(scales))
suppressMessages (library(DT))
suppressMessages (library(quantreg))
suppressMessages (library(tidyr))
suppressMessages (library(dplyr))
suppressMessages (library(Hmisc))
#source("resamplestratifiedsamples.R")
#sampledata <- resample_df(dataplot,"SUBJID", "SITE",
#                          n=round(length(unique(dataplot$SUBJID))*0.1,0), replace = FALSE)

stat_sum_df <- function(fun, geom="point", ...) {
  stat_summary(fun.data=fun,  geom=geom,  ...)
}
stat_sum_single <- function(fun, geom="point", ...) {
  stat_summary(fun.y=fun,  geom=geom,  ...)
}
options(shiny.maxRequestSize=100*1024^2) 
options(shiny.reactlog=TRUE) 


ui  <-  fluidPage(
    titlePanel("Hello User!"),
    sidebarLayout(

      sidebarPanel(
        tabsetPanel(
        tabPanel("Inputs", 
                      tagList(
      singleton(tags$head(tags$script(src='//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js',
                                      type='text/javascript'))),
      singleton(tags$head(tags$script(src='//cdn.datatables.net/tabletools/2.2.4/js/dataTables.tableTools.min.js',
type='text/javascript'))),
      singleton(tags$head(tags$script(src='//cdn.datatables.net/colreorder/1.1.3/js/dataTables.colReorder.min.js',type='text/javascript'))),
      singleton(tags$head(tags$script(src='colvis.js',type='text/javascript'))),
      singleton(tags$head(tags$script(src='//cdn.datatables.net/tabletools/2.2.4/js/ZeroClipboard.min.js',type='text/javascript'))),
      singleton(tags$head(tags$link(href='//cdn.datatables.net/tabletools/2.2.4/css/dataTables.tableTools.css',rel='stylesheet',type='text/css'))),
      singleton(tags$script(HTML("if (window.innerHeight < 400) alert('Screen too small');"))),
    tags$head( tags$style(HTML("
                        .cvclear{
                         text-align:right}"))) 
    ),
    
        #checkboxInput('example', 'Use Example Data',value=TRUE),

fileInput("datafile", "Choose csv file to upload", multiple = FALSE, accept = c("csv")),
                             uiOutput("ycol"),
                             uiOutput("xcol"),
checkboxInput('dilution', 'Sub-sample data', value = FALSE) ,

tabsetPanel(id = "filtercategorize",
        tabPanel("Filters", 
                             uiOutput("maxlevels"),
                             uiOutput("filtervar1"),
                             uiOutput("filtervar1values"),
                             uiOutput("filtervar2"),
                             uiOutput("filtervar2values"),
                             uiOutput("filtervar3"),
                             uiOutput("filtervar3values"),
                             uiOutput("filtervarcont1"),
                             uiOutput("fslider1"),
                             uiOutput("filtervarcont2"),
                             uiOutput("fslider2"),
                             uiOutput("filtervarcont3"),
                             uiOutput("fslider3")
                 ),
        tabPanel("Categorize", 
                             uiOutput("catvar"),
                             uiOutput("ncuts"),
                             uiOutput("catvar2"),
                             uiOutput("catvar3"),
                             uiOutput("ncuts2")
                 ),
        
        tabPanel("Combine Variables", 
                             uiOutput("pastevar")
                 )
        
        ),
    hr()
          ), # tabpanel
tabPanel("Graph Options",
                 column(6,
                 checkboxInput('logy', 'Log Y axis', value = FALSE) ,
                 checkboxInput('logx', 'Log X axis', value = FALSE),
                 hr()),
                 column(6,
                         conditionalPanel(condition = "!input.logy" ,
                 checkboxInput('scientificy', 'Comma separated Y axis ticks', value = FALSE) ),
                                          conditionalPanel(condition = "!input.logx" ,
                 checkboxInput('scientificx', 'Comma separated X axis ticks', value = FALSE))
                 ,hr())
         ,
textInput('ylab', 'Y axis label', value = "") ,
textInput('xlab', 'X axis label', value = "") ,
    selectInput('backgroundcol', label ='Background Color',
                 choices=c("Gray" ="gray97","White"="white","Dark Gray"="grey90"),
                 multiple=FALSE, selectize=TRUE,selected="gray97"),
    selectInput('legendposition', label ='Legend Position',
                 choices=c("left", "right", "bottom", "top"),
                 multiple=FALSE, selectize=TRUE,selected="bottom"),
#selectInput('facetscales','Facet Scales:',c("fixed","free_x","free_y","free")),
uiOutput("facetscales"),
selectInput('facetspace' ,'Facet Spaces:',c("fixed","free_x","free_y","free")),
checkboxInput('facetwrap', 'Use facet_wrap ?'),
 conditionalPanel(condition = "input.facetwrap" ,
           numericInput("wrapncol",label = "N columns",value = 2,min=1,max =10) ,
           numericInput("wrapnrow",label = "N rows",value = 2,min=1,max=10) 
                  ),
h4("Reference Lines ?"),
    checkboxInput('identityline', 'Identity Line')    ,   
    checkboxInput('horizontalzero', 'Horizontol Zero Line'),
    checkboxInput('customline1', 'Vertical Line'),
 conditionalPanel(condition = "input.customline1" , 
   numericInput("vline",label = "",value = 1) ),
   checkboxInput('customline2', 'Horizontal Line'),
 conditionalPanel(condition = "input.customline2" , 
   numericInput("hline",label = "",value = 1) ),
h4("Additional Themes Options ?"),
    checkboxInput('themebw', 'Use ggplot Black and White Theme ?')   , 
    checkboxInput('themeaspect', 'Use custom aspect ratio ?')   ,  
 conditionalPanel(condition = "input.themeaspect" , 
  numericInput("aspectratio",label = "Y/x ratio",value = 1) ),
    checkboxInput('sepguides', 'Separate Legend Guides for Median/PI ?',value = TRUE),       
    checkboxInput('labelguides', 'Hide the Names of the Guides ?',value = FALSE)       
),

tabPanel("How To",
                 h5("1. Upload your data file in CSV format. R default options for read.csv will apply except for missing values where both (NA) and dot (.) are treated as missing. If your data has columns with other non-numeric missing value codes then they be treated as factors."),
                 h5("2. It is assumed that your data is ready for ggplot (long format)."),                                   h5("3. x and y variable(s) input allow numeric and factor variables."),
                 h5("4. Changed ! Sliders for x and y variables were removed. Use the Filter variables tab to select up to 6 different filters."),  
                 h5("5. New ! You can now select more than one y variable. The data will be automatically stacked using tidyr::gather and result in yvars and yvalues variables. if you select factor and continuous variables data will be transformed to factor. The internal variable yvalues is used for y variable mapping and you can select yvars for facetting. The app automatically select additional row split as yvars and set Facet Scales to free_y. To change Facet Scales and many other options go to Graph Options tab."),
                 h5("6. The UI is dynamic and changes depending on your choices of options, x ,y, filter, group and so on."),
                 h5("7. There is now six slots for Filter variables. Use these to apply exclusions on your data."),
                 h5("8. New ! Filter variables 1, 2,3,4,5 and 6 are applied sequentially. Values shown for filter variable 2 will depend on your selected data exclusions using filter variable 1 and so on. The first three filters accept numeric and non numeric columns while the last three are sliders and only work with numeric variables."),
         h5("9. If you want to change a numerical variable to categorical include it in the list of Categorical variables and then choose a number of cuts (default is 3). This helps when you want to group or color by cuts of a continuous variable."),
                 h5("10. You can simply change a numeric variable to factor without binning in the treat as categories slot."),
                          h5("11. New ! You can cut a numeric variable to factor using specified cutoffs, by default the min, median, max are used."),
                                   h5("12. New ! You can additional smoothing functions added including linear fit and logistic user needs to make sure that data is compatible with the smoothing used i.e for logistic a 0/1 variable is expected."),
               h5("13. Initial support to include boxplots and allow facet wrap is now on. More work needed. Especially that grouping does not work when x axis variable is not continuous and that facet wrap breaks when formula has dots."),
                 h5("14. Download the plot using the options on the 'Download' tab. This section is based on code from Mason DeCamillis ggplotLive app."),
                 h5("15. Visualize the data table in the 'Data' tab. You can reorder the columns, filter and much more."),
                p(),
                 h5("Samer Mouksassi 2016"),
               h5("Contact me @ samermouksassi@gmail.com for feedback/Bugs/features requests!")

                 )# tabpanel 
        )
      ), #sidebarPanel
      mainPanel(
        tabsetPanel(
          tabPanel("Plot"  , 
plotOutput('plot',  width = "100%" ,click = "plot_click",
hover = hoverOpts(id = "plot_hover", delayType = "throttle"),
                       brush = brushOpts(id = "plot_brush")),
                    #verbatimTextOutput("plotinfo"),
                hr(),
                       uiOutput("clickheader"),
             tableOutput("plot_clickedpoints"),
                       uiOutput("brushheader"),
             tableOutput("plot_brushedpoints"),
#actionButton("plotButton", "Update Plot"),
          uiOutput("optionsmenu") ,

                conditionalPanel(
                 condition = "input.showplottypes" , 
                 
                 fluidRow(
                           
                     column (12, hr()),
                     column (3,
                             radioButtons("Points", "Points/Jitter:",
                                          c("Points" = "Points",
                                            "Jitter" = "Jitter",
                                            "None" = "None")),
                             conditionalPanel( " input.Points!= 'None' ",
sliderInput("pointstransparency", "Points Transparency:", min=0, max=1, value=c(0.5),step=0.01))
                             ),
                     column(3,
                     conditionalPanel( " input.Points!= 'None' ",
sliderInput("pointsizes", "Points Size:", min=0, max=4, value=c(1),step=0.1),
numericInput('pointtypes','Points Type:',16, min = 1, max = 25)
)),
                     
                     column (3,
                          
                             radioButtons("line", "Lines:",
                                          c("Lines" = "Lines",
                                             "None" = "None"),selected="None"),
                     conditionalPanel( " input.line== 'Lines' ",
sliderInput("linestransparency", "Lines Transparency:", min=0, max=1, value=c(0.5),step=0.01),
checkboxInput('lineignorecol', 'Ignore Mapped Color')
                                      )
                             
                             ),
                     column(3,
                     conditionalPanel( " input.line== 'Lines' ",
                           sliderInput("linesize", "Lines Size:", min=0, max=4, value=c(1),step=0.1),
                           selectInput('linetypes','Lines Type:',c("solid","dotted")),
                     conditionalPanel( " input.lineignorecol ",
                           selectInput('colline', label ='Lines Color', choices=colors(),multiple=FALSE, selectize=TRUE,selected="black") 
                            )
                           ),
                     checkboxInput('boxplotaddition', 'Add a Boxplot ? (makes sense if x variable is categorical and you Group By using it, other features might not work on top of boxplot e.g loess)')

                     ),
column (12, h6("Points and Lines Size will apply only if Size By: in the Color Group Split Size Fill Mappings are set to None"))
           
                     )#fluidrow
                 ) ,
      conditionalPanel(
                 condition = "input.showfacets" , 
                     fluidRow(
                     column (12, hr()),
                     column (3, uiOutput("colour"),uiOutput("group")),
                     column(3, uiOutput("facet_col"),uiOutput("facet_row")),
                     column (3, uiOutput("facet_col_extra"),uiOutput("facet_row_extra")),
                     column (3, uiOutput("pointsize"),uiOutput("fill")),
                     column (12, h6("Make sure not to choose a variable that is in the y variable(s) list otherwise you will get an error Variable not found. These variables are stacked and become yvars and yvalues." ))

                   )
                 ),
                 


 
#rqss quantile regression
conditionalPanel(
                 condition = "input.showrqss" , 

fluidRow(
  column(12,hr()),
  column(3,
      checkboxInput('Tauvalue', 'Dynamic and Preset Quantiles', value = FALSE),
      h5("Preset Quantiles"),
      checkboxInput('up', '95%'),
      checkboxInput('ninetieth', '90%'),
      checkboxInput('mid', '50%', value = FALSE),
      checkboxInput('tenth', '10%'),
      checkboxInput('low', '5%')
),
  column(5,
         sliderInput("Tau", label = "Dynamic Quantile Value:",
              min = 0, max = 1, value = 0.5, step = 0.01)  ,
          sliderInput("Penalty", label = "Spline sensitivity adjustment:",
              min = 0, max = 10, value = 1, step = 0.1)  ,
            selectInput("Constraints", label = "Spline constraints:",
              choices = c("N","I","D","V","C","VI","VD","CI","CD"), selected = "N")
  ),
  column(3,
checkboxInput('ignorecolqr', 'Ignore Mapped Color'),
checkboxInput('ignoregroupqr', 'Ignore Mapped Group',value = TRUE),
checkboxInput('hidedynamic', 'Hide Dynamic Quantile'),
selectInput('colqr', label ='QR Color', choices=colors(),multiple=FALSE, selectize=TRUE,selected="black")
      )

                      )#fluidrow
                   ),

conditionalPanel(
                 condition = "input.showSmooth" , 

fluidRow(
  column(12,hr()),
  column (3, 
                                              radioButtons("Smooth", "Smooth:",
                                          c("Smooth" = "Smooth",
                                            "Smooth and SE" = "Smooth and SE",
                                            "None" = "None"),selected="None")
          ),
  column (3, 
                          conditionalPanel( " input.Smooth!= 'None' ",
              selectInput('smoothmethod', label ='Smoothing Method',
                 choices=c("Loess" ="loess","Linear Fit"="lm","Logistic"="glm"),
                 multiple=FALSE, selectize=TRUE,selected="loess"),
          
          sliderInput("loessens", "Loess Span:", min=0, max=1, value=c(0.75),step=0.05)
             ) 
          ),

  
 
  
  
  column (3,  conditionalPanel( " input.Smooth!= 'None' ",
                                checkboxInput('ignorecol', 'Ignore Mapped Color'),
uiOutput("weight")
  )
          ),
    column (3, conditionalPanel( " input.Smooth!= 'None' ",
                                 checkboxInput('ignoregroup', 'Ignore Mapped Group',value = TRUE),
                selectInput('colsmooth', label ='Smooth Color', choices=colors(),multiple=FALSE, selectize=TRUE,selected="black")
                        ) )

                      )#fluidrow
                   )
,
### Mean CI section
   conditionalPanel(
                 condition = "input.showMean" , 
                 
fluidRow(
  column(12,hr()),
  column (3, 
           radioButtons("Mean", "Mean:",
                       c("Mean" = "Mean",
                         "Mean (95% CI)" = "Mean (95% CI)",
                         "None" = "None") ,selected="None") 
          ),
 column (3,

         conditionalPanel( " input.Mean== 'Mean (95% CI)' ",
                           sliderInput("CI", "CI %:", min=0, max=1, value=c(0.95),step=0.01),
         numericInput( inputId = "errbar",label = "CI bar width:",value = 2,min = 1,max = NA)      
 )

         )
 ,
column (3,
  conditionalPanel( " input.Mean!= 'None' ",
         checkboxInput('meanpoints', 'Show points') ,
         checkboxInput('meanlines', 'Show lines', value=TRUE),
checkboxInput('meanignorecol', 'Ignore Mapped Color') ,
                 conditionalPanel( " input.meanignorecol ",
        selectInput('colmean', label ='Mean Color', choices=colors(),multiple=FALSE, selectize=TRUE,selected="black") )

                       ) ),
 
 
 column(3,
  conditionalPanel( " input.Mean!= 'None' ",
checkboxInput('meanignoregroup', 'Ignore Mapped Group',value = TRUE),
sliderInput("meanlinesize", "Mean(s) Line(s) Size:", min=0, max=3, value=1,step=0.05)
  ) 
)
                      ) #fluidrow
), # conditional panel for mean

### median PI section


   conditionalPanel(
                 condition = "input.showMedian" , 
fluidRow(
  column(12,hr()),
  column (3,
          radioButtons("Median", "Median:",
                       c("Median" = "Median",
                         "Median/PI" = "Median/PI",
                         "None" = "None") ,selected="None") 
          ),
   column (3,
  conditionalPanel( " input.Median== 'Median' ",
       checkboxInput('medianpoints', 'Show points') ,
       checkboxInput('medianlines', 'Show lines',value=TRUE)),
    conditionalPanel( " input.Median== 'Median/PI' ",
      sliderInput("PI", "PI %:", min=0, max=1, value=c(0.95),step=0.01),
      sliderInput("PItransparency", "PI Transparency:", min=0, max=1, value=c(0.2),step=0.01)
)
         ),
   column (3,
  conditionalPanel( " input.Median!= 'None' ",
        checkboxInput('medianignorecol', 'Ignore Mapped Color'),
     conditionalPanel( " input.medianignorecol ",
        selectInput('colmedian', label ='Median Color', choices=colors(),multiple=FALSE, selectize=TRUE,selected="black") )

                       ) ),
  column (3,
                        conditionalPanel( " input.Median!= 'None' ",

         checkboxInput('medianignoregroup', 'Ignore Mapped Group',value = TRUE),
         sliderInput("medianlinesize", "Median(s) Line(s) Size:", min=0, max=4, value=c(1),step=0.1)

                        )
                        )
  
                      )#fluidrow
)
### median PI section

          ),#tabPanel1
          tabPanel("Download", 
                     selectInput(
                     inputId = "downloadPlotType",
                     label   = h5("Select download file type"),
                     choices = list("PDF"  = "pdf","BMP"  = "bmp","JPEG" = "jpeg","PNG"  = "png")),
                   
                   # Allow the user to set the height and width of the plot download.
                   h5(HTML("Set download image dimensions<br>(units are inches for PDF, pixels for all other formats)")),
                     numericInput(
                     inputId = "downloadPlotHeight",label = "Height (inches)",value = 7,min = 1,max = 100),
                     numericInput(
                     inputId = "downloadPlotWidth",label = "Width (inches)",value = 7,min = 1,max = 100),
                           # Choose download filename.
                   textInput(
                     inputId = "downloadPlotFileName",
                     label = h5("Enter file name for download")),
                   
                   # File downloads when this button is clicked.
                   downloadButton(
                     outputId = "downloadPlot", 
                     label    = "Download Plot")
          ),
          
          tabPanel('Data',  dataTableOutput("mytablex") 
          )#tabPanel2
        )#tabsetPanel
         )#mainPanel
    )#sidebarLayout
  )#fluidPage
  

server <-  function(input, output, session) {
filedata <- reactive({
    infile <- input$datafile
    if (is.null(infile)) {
      # User has not uploaded a file yet
      return(NULL)
    }
    read.csv(infile$datapath,na.strings = c("NA","."))
        

  })
      


myData <- reactive({
    df=filedata()
    if (is.null(df)) return(NULL)
})
    
output$optionsmenu <-  renderUI({
  df <-filedata()
    if (is.null(df)) return(NULL)
  
             fluidRow(
             column (12, h6("Select the checkbox(es) for the options to be showed")),
                        hr(),
                      column(4,checkboxInput('showplottypes','Plot types, Points, Lines (?)',
                                             value = TRUE)),
                      column(4,checkboxInput('showfacets','Color/Group/Split/Size/Fill Mappings (?)',
                                             value = TRUE) ),
                      column(4,checkboxInput('showrqss', 'Quantire Regresssion (?)',
                                             value = TRUE)),
                      column(4,checkboxInput('showSmooth', 'Smooth SE (?)', value = TRUE)),
                      column(4,checkboxInput('showMean' , 'Mean CI (?)', value = FALSE)),
                      column(4,checkboxInput('showMedian','Median PIs (Show ?)', value = FALSE))
                      )
 })


  output$ycol <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    selectInput("y", "y variable(s):",choices=items,selected = items[1],multiple=TRUE,selectize=TRUE)
  })
  
output$xcol <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    selectInput("x", "x variable:",items,selected=items[2])
    
  })
       
# output$slider <- renderUI({
#     df <-filedata()
#     xvariable<- input$x
#     if (is.null(df)) return(NULL)
#     if (!is.numeric(df[,xvariable]) ) return(NULL)
# if(is.numeric(df[,xvariable]) )  {
# sliderInput("inSlider"    ,label = paste(xvariable,"Range"),
#                 min=min(df[,xvariable],na.rm=T),
#                 max=max(df[,xvariable],na.rm=T),
#                 value=c(min(df[,xvariable],na.rm=T),max(df[,xvariable],na.rm=T)) 
#     )
# }
# 
#   })
# output$slidercat <- renderUI({
#     df <-filedata()
#     xvariable<- input$x
#     if ( is.null(df)) return(NULL)
#     if ( is.numeric(df[,xvariable]) ) return(NULL)
#     if (!is.numeric(df[,xvariable]) )  {
# selectInput('inSlidercat',label = paste("Select values", xvariable),
# choices = levels(as.factor(df[,xvariable]) ),
# selected = levels(as.factor(df[,xvariable]) ),
# multiple=TRUE, selectize=FALSE)   
#  }
# })
# 
# 
# output$slider2 <- renderUI({
#     df <-filedata()
#     yvariable<- input$y
#     if (is.null(df)) return(NULL)
#     if (length ( unlist(input$y))>=2) return(NULL)
#     if (length ( unlist(input$y) )<2){
#     if (!is.numeric(df[,yvariable]) ) return(NULL)
# if(is.numeric(df[,yvariable]) )  {
# sliderInput("inSlider2"    ,label = paste(yvariable,"Range"),
#                 min=min(df[,yvariable],na.rm=T),
#                 max=max(df[,yvariable],na.rm=T),
#                 value=c(min(df[,yvariable],na.rm=T),max(df[,yvariable],na.rm=T)) 
#     )
# }
#     }
#     
#   })
# output$slidercat2 <- renderUI({
#     df <-filedata()
#     yvariable<- input$y
#     if (is.null(df)) return(NULL)
#     if (length ( unlist(input$y))>=2) return(NULL)
#     
#     if (length ( unlist(input$y))<2){
#     if ( is.numeric(df[,yvariable]) ) return(NULL)
#     if (!is.numeric(df[,yvariable]) )  {
# selectInput('inSlidercat2',label = paste("Select values", yvariable),
# choices = levels(as.factor(df[,yvariable]) ),
# selected = levels(as.factor(df[,yvariable]) ),
# multiple=TRUE, selectize=FALSE)   
#     }
#      }
# 
# })



 output$maxlevels <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    numericInput( inputId = "inmaxlevels",label = "Max number of unique values for filter variables (1,2,3):",value = 250,min = 1,max = NA)
    
 })


 output$filtervar1 <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
   NUNIQUEDF <- sapply(df, function(x) length(unique(x)))
   NAMESTOKEEP<- names(df)  [ NUNIQUEDF  < input$inmaxlevels ]
   selectInput("infiltervar1" , "Filter variable (1):",c('None',NAMESTOKEEP ) )
      })
 
  output$filtervar1values <- renderUI({
    df <-filedata()
validate(       need(!is.null(df), "Please select a data set"))
        
    if (is.null(df)) return(NULL)
 if(input$infiltervar1=="None") {return(NULL)}
 if(input$infiltervar1!="None" )  {
choices <- levels(as.factor(df[,input$infiltervar1]))
selectInput('infiltervar1valuesnotnull',
label = paste("Select values", input$infiltervar1),
choices = c(choices),
selected = choices,
multiple=TRUE, selectize=FALSE)   
}
  })  
        

subsetdata  <- reactive({
    df <- filedata()
#     if (is.null(df)) return(NULL)
#     xvariable<- input$x
#     yvariable<- input$y
#         
#     if(!is.null(input$inSlidercat)& !is.numeric(df[,xvariable]) ) {
#  df <-  df [ is.element(df[,input$x],input$inSlidercat),]
#     }
#     if(!is.null(input$inSlidercat2)& !is.numeric(df[,yvariable])) {
#  df <-  df [ is.element(df[,input$y],input$inSlidercat2),]
#     }
#    
#     if(!is.null(input$inSlider)&is.numeric(df[,xvariable])) {
#     if(is.numeric( input$inSlider[1]) & is.numeric(df[,input$x]))
#       {df <- df [!is.na(df[,input$x]),]
#        df <- df [df[,input$x] >= input$inSlider[1]&df[,input$x] <= input$inSlider[2],]
#       }
#     }
#     if(!is.null(input$inSlider2)&is.numeric(df[,yvariable])) {
#     if(is.numeric( input$inSlider2[1])& is.numeric(df[,input$y]) ) {
#       df<- df [!is.na(df[,input$y]),]
#       df <-  df [df[,input$y] >= input$inSlider2[1]&df[,input$y] <= input$inSlider2[2],]
#     }  
#     }
    
   df
}) 
  output$filtervar2 <- renderUI({
        df <- filedata()
            if (is.null(df)) return(NULL)
   NUNIQUEDF <- sapply(df, function(x) length(unique(x)))
   NAMESTOKEEP<- names(df)  [ NUNIQUEDF  < input$inmaxlevels ]
   NAMESTOKEEP<-  NAMESTOKEEP[ NAMESTOKEEP!=input$infiltervar1 ]

   selectInput("infiltervar2" , "Filter variable (2):",c('None',NAMESTOKEEP ) )
      })

  output$filtervar3 <- renderUI({
        df <- filedata()
            if (is.null(df)) return(NULL)
   NUNIQUEDF <- sapply(df, function(x) length(unique(x)))
   NAMESTOKEEP<- names(df)  [ NUNIQUEDF  < input$inmaxlevels ]
   NAMESTOKEEP<-  NAMESTOKEEP[ NAMESTOKEEP!=input$infiltervar1 ]
   NAMESTOKEEP<-  NAMESTOKEEP[ NAMESTOKEEP!=input$infiltervar2 ]

   selectInput("infiltervar3" , "Filter variable (3):",c('None',NAMESTOKEEP ) )
      })
    
         
  output$filtervarcont1 <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
   NUNIQUEDF <- sapply(df, function(x) length(unique(x)))
   NAMESTOKEEP<- names(df)
    NAMESTOKEEP<- NAMESTOKEEP[ is.element ( NAMESTOKEEP,names(df[sapply(df,is.numeric)]))]
   selectInput("infiltervarcont1" , "Filter continuous (1):",c('None',NAMESTOKEEP ) )
      })
  output$filtervarcont2 <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
   NUNIQUEDF <- sapply(df, function(x) length(unique(x)))
   NAMESTOKEEP<- names(df)  
    NAMESTOKEEP<- NAMESTOKEEP[ is.element ( NAMESTOKEEP,names(df[sapply(df,is.numeric)]))]
   selectInput("infiltervarcont2" , "Filter continuous (2):",c('None',NAMESTOKEEP ) )
      })
    output$filtervarcont3 <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
   NUNIQUEDF <- sapply(df, function(x) length(unique(x)))
   NAMESTOKEEP<- names(df)  
    NAMESTOKEEP<- NAMESTOKEEP[ is.element ( NAMESTOKEEP,names(df[sapply(df,is.numeric)]))]
   selectInput("infiltervarcont3" , "Filter continuous (3):",c('None',NAMESTOKEEP ) )
      })
  
     filterdata  <- reactive({
        if (is.null(filedata())) return(NULL)
       df <- subsetdata()
       if (is.null(df)) return(NULL)
       if(is.null(input$infiltervar1)) {
         df <-  df 
    }
     if(!is.null(input$infiltervar1)&input$infiltervar1!="None") {

          df <-  df [ is.element(df[,input$infiltervar1],input$infiltervar1valuesnotnull),]
    }

 df
     })
     
output$filtervar2values <- renderUI({
   df <- filterdata()
   if (is.null(df)) return(NULL)
 if(input$infiltervar2=="None") {
   selectInput('infiltervar2valuesnull',
            label ='No filter variable 2 specified', 
             choices = list(""),multiple=TRUE, selectize=FALSE)   
                                }
 if(input$infiltervar2!="None"&!is.null(input$infiltervar2) )  {
choices <- levels(as.factor(as.character(df[,input$infiltervar2])))
selectInput('infiltervar2valuesnotnull',
label = paste("Select values", input$infiltervar2),
choices = c(choices),
selected = choices,
multiple=TRUE, selectize=TRUE)   
}
  })

  filterdata2  <- reactive({
      df <- filterdata()
      if (is.null(df)) return(NULL)
    if(!is.null(input$infiltervar2)&input$infiltervar2!="None") {
      df <-  df [ is.element(df[,input$infiltervar2],input$infiltervar2valuesnotnull),]
    }
      if(input$infiltervar2=="None") {
      df 
      }
 df
})
output$filtervar3values <- renderUI({
   df <- filterdata2()
   if (is.null(df)) return(NULL)
 if(input$infiltervar3=="None") {
   selectInput('infiltervar3valuesnull',
            label ='No filter variable 2 specified', 
             choices = list(""),multiple=TRUE, selectize=FALSE)   
                                }
 if(input$infiltervar3!="None"&!is.null(input$infiltervar3) )  {
choices <- levels(as.factor(as.character(df[,input$infiltervar3])))
selectInput('infiltervar3valuesnotnull',
label = paste("Select values", input$infiltervar3),
choices = c(choices),
selected = choices,
multiple=TRUE, selectize=TRUE)   
}
  })
  
  filterdata3  <- reactive({
      df <- filterdata2()
      if (is.null(df)) return(NULL)
    if(!is.null(input$infiltervar3)&input$infiltervar3!="None") {
      df <-  df [ is.element(df[,input$infiltervar3],input$infiltervar3valuesnotnull),]
    }
      if(input$infiltervar3=="None") {
      df 
      }
 df
})  
    
output$fslider1 <- renderUI({ 
      df <-  filterdata3()
      if (is.null(df)) return(NULL)
    xvariable<- input$infiltervarcont1
     if(input$infiltervarcont1=="None" ){
       return(NULL)  
}
    if (!is.numeric(df[,xvariable]) ) return(NULL)
         if(input$infiltervarcont1!="None" ){
    sliderInput("infSlider1", paste("Select",xvariable,"Range"),
                min=min(df[,xvariable],na.rm=T),
                max=max(df[,xvariable],na.rm=T),
                value=c(min(df[,xvariable],na.rm=T),max(df[,xvariable],na.rm=T)) 
    )
         }             
  })
  filterdata4  <- reactive({
     df <- filterdata3()
      if (is.null(df)) return(NULL)
       if(input$infiltervarcont1!="None" ){
      if(is.numeric( input$infSlider1[1]) & is.numeric(df[,input$infiltervarcont1])) {
   df <- df [!is.na(df[,input$infiltervarcont1]),]
   df <-  df [df[,input$infiltervarcont1] >= input$infSlider1[1]&df[,input$infiltervarcont1] <= input$infSlider1[2],]
      }
       }

df
})
output$fslider2 <- renderUI({ 
      df <-  filterdata4()
      if (is.null(df)) return(NULL)
    xvariable<- input$infiltervarcont2
     if(input$infiltervarcont2=="None" ){
       return(NULL)  
}
    if (!is.numeric(df[,xvariable]) ) return(NULL)
         if(input$infiltervarcont2!="None" ){
    sliderInput("infSlider2", paste("Select",xvariable,"Range"),
                min=min(df[,xvariable],na.rm=T),
                max=max(df[,xvariable],na.rm=T),
                value=c(min(df[,xvariable],na.rm=T),max(df[,xvariable],na.rm=T)) 
    )
         }             
  })


  filterdata5  <- reactive({
     df <- filterdata4()
      if (is.null(df)) return(NULL)
        if(input$infiltervarcont2!="None" ){
      if(is.numeric( input$infSlider2[1]) & is.numeric(df[,input$infiltervarcont2])) {
  df<- df [!is.na(df[,input$infiltervarcont2]),]
  df<-df [df[,input$infiltervarcont2] >= input$infSlider2[1]&df[,input$infiltervarcont2] <= input$infSlider2[2],]
      }
            }
      
df
})

  output$fslider3 <- renderUI({ 
      df <-  filterdata5()
      if (is.null(df)) return(NULL)
    xvariable<- input$infiltervarcont3
     if(input$infiltervarcont3=="None" ){
       return(NULL)  
}
    if (!is.numeric(df[,xvariable]) ) return(NULL)
         if(input$infiltervarcont3!="None" ){
    sliderInput("infSlider3", paste("Select",xvariable,"Range"),
                min=min(df[,xvariable],na.rm=T),
                max=max(df[,xvariable],na.rm=T),
                value=c(min(df[,xvariable],na.rm=T),max(df[,xvariable],na.rm=T)) 
    )
         }             
  })


  filterdata6  <- reactive({
     df <- filterdata5()
      if (is.null(df)) return(NULL)
        if(input$infiltervarcont3!="None" ){
      if(is.numeric( input$infSlider3[1]) & is.numeric(df[,input$infiltervarcont3])) {
  df<- df [!is.na(df[,input$infiltervarcont3]),]
  df<-df [df[,input$infiltervarcont3] >= input$infSlider3[1]&df[,input$infiltervarcont3] <= input$infSlider3[2],]
      }
            }
      
df
})
  
  
output$catvar <- renderUI({
    df <-filedata()
   if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
   MODEDF <- sapply(df, function(x) is.numeric(x))
   NAMESTOKEEP2<- names(df)  [ MODEDF ]
   selectInput('catvarin',label = 'Recode into Binned Categories:',choices=NAMESTOKEEP2,multiple=TRUE)
  })


output$ncuts <- renderUI({
    if (length(input$catvarin ) <1)  return(NULL)
   sliderInput('ncutsin',label = 'N of Cut Breaks:', min=2, max=10, value=c(3),step=1)
  })

output$catvar2 <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
   MODEDF <- sapply(df, function(x) is.numeric(x))
   NAMESTOKEEP2<- names(df)  [ MODEDF ]
    if (length(input$catvarin ) >=1) {
         NAMESTOKEEP2<-NAMESTOKEEP2 [ !is.element(NAMESTOKEEP2,input$catvarin) ]
    }
  
   selectInput('catvar2in',label = 'Treat as Categories:',choices=NAMESTOKEEP2,multiple=TRUE)
   
  })

output$catvar3 <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
   MODEDF <- sapply(df, function(x) is.numeric(x))
   NAMESTOKEEP2<- names(df)  [ MODEDF ]
    if (length(input$catvarin ) >=1) {
         NAMESTOKEEP2<-NAMESTOKEEP2 [ !is.element(NAMESTOKEEP2,input$catvarin) ]
    }
      if (length(input$catvar2in ) >=1) {
         NAMESTOKEEP2<-NAMESTOKEEP2 [ !is.element(NAMESTOKEEP2,input$catvar2in) ]
    }
   selectizeInput(  "catvar3in", 'Custom cuts of this variable, defaults to min, median, max before any applied filtering:',
                    choices =NAMESTOKEEP2 ,multiple=FALSE,
  options = list(    placeholder = 'Please select a variable',
    onInitialize = I('function() { this.setValue(""); }')
  )
)
  })
output$ncuts2 <- renderUI({
  df <-filedata()
    if (length(input$catvar3in ) <1)  return(NULL)
  if ( input$catvar3in!=""){
 textInput("xcutoffs", label =  paste(input$catvar3in,"Cuts"),
          value = as.character(paste(
             min(df[,input$catvar3in] ,na.rm=T),
              median(df[,input$catvar3in],na.rm=T),
              max(df[,input$catvar3in],na.rm=T) ,sep=",")
          )
 )
    }
        
  })
  outputOptions(output, "ncuts2", suspendWhenHidden=FALSE)
  outputOptions(output, "catvar3", suspendWhenHidden=FALSE)


  output$pastevar <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
   MODEDF <- sapply(df, function(x) is.numeric(x))
   NAMESTOKEEP2<- names(df)  [! MODEDF ]
   selectizeInput(  "pastevarin", "Combine the categories of these two variables:", choices = NAMESTOKEEP2,multiple=TRUE,
  options = list(
    maxItems = 2 ,
    placeholder = 'Please select some variables',
    onInitialize = I('function() { this.setValue(""); }')
  )
  )
   
   
    
  })

    
  

  recodedata1  <- reactive({
      df <- filterdata6() 
      if (is.null(df)) return(NULL)
if(length(input$catvarin ) >=1) {
       for (i in 1:length(input$catvarin ) ) {
         varname<- input$catvarin[i]
       df[,varname] <- cut(df[,varname],input$ncutsin)
       df[,varname]   <- as.factor( df[,varname])
       }
}
 df
})
  
  
  recodedata2  <- reactive({
      df <- recodedata1()
      if (is.null(df)) return(NULL)
    if(length(input$catvar2in ) >=1) {
       for (i in 1:length(input$catvar2in ) ) {
         varname<- input$catvar2in[i]
       df[,varname]   <- as.factor( df[,varname])
       }
}
 df
})

  recodedata3  <- reactive({
      df <- recodedata2()
      if (is.null(df)) return(NULL)
    if(input$catvar3in!="") {
       for (i in 1:length(input$catvar3in ) ) {
         varname<- input$catvar3in[i]
       xlimits <- input$xcutoffs 
       nxintervals <- length(as.numeric(unlist (strsplit(xlimits, ",")) )) -1
   df[,varname] <- cut( as.numeric ( as.character(  df[,varname])),
                        breaks=   as.numeric(unlist (strsplit(xlimits, ","))),include.lowest=TRUE)
#df[,varname] <- as.numeric(df[,varname] ) -1
#xaxislabels <-levels(cut( as.numeric ( as.character( df[,varname])), breaks=   as.numeric(unlist (strsplit(xlimits, ",") ))))
       }
}
 df
})
    

  stackdata <- reactive({

  df <- recodedata3() 

  if (is.null(df)) return(NULL)
  if (!is.null(df)){
        validate(  need(!is.element(input$x,input$y) , "Please select a different x variable or remove the x variable from the list of y variable(s)"))

 if(       all( sapply(df[,as.vector(input$y)], is.numeric)) )
 {
   tidydata <- df %>%
  gather_( "yvars", "yvalues", gather_cols=as.vector(input$y) ) %>%
      mutate(combinedvariable="Choose two variables to combine first")
 }
  if(       any( sapply(df[,as.vector(input$y)], is.factor)) |
            any( sapply(df[,as.vector(input$y)], is.character)))
  {
    tidydata <- df %>%
  gather_( "yvars", "yvalues", gather_cols=as.vector(input$y) ) %>%
  mutate(yvalues=as.factor(as.factor(as.character(yvalues)) ))%>%
      mutate(combinedvariable="Choose two variables to combine first")
  } 

     if(       all( sapply(df[,as.vector(input$y)], is.factor)) |
            all( sapply(df[,as.vector(input$y)], is.character)))
  {
    tidydata <- df %>%
  gather_( "yvars", "yvalues", gather_cols=as.vector(input$y) ) %>%
  mutate(yvalues=as.factor(as.character(yvalues) ))%>%
      mutate(combinedvariable="Choose two variables to combine first")
  }    

  
      }

     if( !is.null(input$pastevarin)   ) {
       if (length(input$pastevarin) > 1) {
               tidydata <- tidydata %>%
    unite_("combinedvariable" , c(input$pastevarin[1], input$pastevarin[2] ),
           remove=FALSE)
       }
      }

tidydata
})
#outputOptions(output, "fslider1", suspendWhenHidden=FALSE)


        
  
    
output$colour <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    items= items #[!is.element(items,input$y)]
    selectInput("colorin", "Colour By:",c("None",items,"yvars", "yvalues","combinedvariable") )
    
  })


output$group <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    items= items 
    
  if (input$boxplotaddition ){
   items= c(input$x,None=".",items[items!=input$x], "yvalues","combinedvariable")    
    }
    if (!input$boxplotaddition ){
   items= c("None",items,"yvars", "yvalues","combinedvariable")    
    }
    selectInput("groupin", "Group By:",items)
  })


output$facet_col <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    items= items #[!is.element(items,input$y)]
    selectInput("facetcolin", "Column Split:",c(None='.',items,"yvars", "yvalues","combinedvariable"))
      })
output$facet_row <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
        items= items #[!is.element(items,input$y)]
    selectInput("facetrowin", "Row Split:",    c(None=".",items,"yvars", "yvalues","combinedvariable"))
      })

output$facet_col_extra <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    items= items #[!is.element(items,input$y)]
    selectInput("facetcolextrain", "Extra Column Split:",c(None='.',items,"yvars", "yvalues","combinedvariable"))
      })
output$facet_row_extra <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    items= items #[!is.element(items,input$y)]
    if (length(input$y) > 1 ){
   items= c("yvars",None=".",items, "yvalues","combinedvariable")    
    }
    if (length(input$y) < 2 ){
   items= c(None=".",items,"yvars", "yvalues","combinedvariable")    
    }
    selectInput("facetrowextrain", "Extra Row Split:",items)
      })


output$facetscales <- renderUI({
    if (length(input$y) > 1 ){
   items= c("free_y","fixed","free_x","free")    
    }
    if (length(input$y) < 2 ){
   items= c("fixed","free_x","free_y","free")   
    }
  selectInput('facetscalesin','Facet Scales:',items)
      })
  outputOptions(output, "facetscales", suspendWhenHidden=FALSE)



output$pointsize <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
        items= items #[!is.element(items,input$y)]
    selectInput("pointsizein", "Size By:",c("None",items,"yvars", "yvalues","combinedvariable") )
    
  })

output$fill <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
        items= items #[!is.element(items,input$y)]
    selectInput("fillin", "Fill By:"    ,c("None",items,"yvars", "yvalues","combinedvariable") )
  })

output$weight <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
        items= items #[!is.element(items,input$y)]
    selectInput("weightin", "Weight By:",c("None",items,"yvars", "yvalues","combinedvariable") )
  })
  outputOptions(output, "weight", suspendWhenHidden=FALSE)



   output$mytablex = renderDataTable({
datatable( stackdata() ,#  recodedata2()
          extensions = c('ColReorder','TableTools'),
          options = list(dom = 'RMD<"cvclear"C><"clear"T>lfrtip',
                         searchHighlight = TRUE,
                         pageLength=10 ,
                         lengthMenu = list(c(5, 10, 15, -1), c('5','10', '15', 'All')),
                         colReorder = list(realtime = TRUE),
                         tableTools = list(
    "sSwfPath" = "//cdnjs.cloudflare.com/ajax/libs/datatables-tabletools/2.1.5/swf/copy_csv_xls.swf",
    "aButtons" = list(
      "copy",
      "print",
      list("sExtends" = "collection",
           "sButtonText" = "Save",
           "aButtons" = c("csv","xls")
      )
    )
  )
                         ), 
          filter = 'bottom',
   style = "bootstrap")
})

  

# `%then%` <- shiny:::`%OR%`  
       
 plotObject <- reactive({
validate(
  need(!is.null(stackdata()), "Please select a data set") 
)
      
      plotdata <- stackdata()
      if(!is.null(plotdata)) {
          p <- ggplot(plotdata, aes_string(x=input$x, y="yvalues")) 

      if (input$colorin != 'None')
           p <- p + aes_string(color=input$colorin)
      if (input$fillin != 'None')
           p <- p + aes_string(fill=input$fillin)
      if (input$pointsizein != 'None')
        p <- p  + aes_string(size=input$pointsizein)
      
      if (input$groupin != 'None' & !is.factor(plotdata[,input$x]))
        p <- p + aes_string(group=input$groupin)
      
      if (input$groupin == 'None' & is.factor(plotdata[,input$x]))
        p <- p + aes(group=1)
      
      if (input$Points=="Points"&input$pointsizein == 'None')
        p <- p + geom_point(,alpha=input$pointstransparency,shape=input$pointtypes,size=input$pointsizes)  
        if (input$Points=="Points"&input$pointsizein != 'None')
        p <- p + geom_point(,alpha=input$pointstransparency,shape=input$pointtypes)
        
        if (input$Points=="Jitter"&input$pointsizein == 'None')
        p <- p + geom_jitter(,alpha=input$pointstransparency,shape=input$pointtypes,size=input$pointsizes)
        if (input$Points=="Jitter"&input$pointsizein != 'None')
        p <- p + geom_jitter(,alpha=input$pointstransparency,shape=input$pointtypes)
        
        
        
        if (input$line=="Lines"&input$pointsizein == 'None')
        p <- p + geom_line(,size=input$linesize,alpha=input$linestransparency,linetype=input$linetypes)
        if (input$line=="Lines"&input$pointsizein != 'None')
        p <- p + geom_line(,alpha=input$linestransparency,linetype=input$linetypes)
        if (input$line=="Lines"&input$pointsizein == 'None'&input$lineignorecol)
        p <- p + geom_line(,size=input$linesize,alpha=input$linestransparency,linetype=input$linetypes,colour=input$colline)
        if (input$line=="Lines"&input$pointsizein != 'None'& input$lineignorecol)
        p <- p + geom_line(,alpha=input$linestransparency,linetype=input$linetypes,colour=input$colline)
        
       
       if (input$boxplotaddition)
        p <- p + geom_boxplot(
          #aes_string(group=input$x)
          )

         
###### Mean section  START 


if (!input$meanignoregroup) {
if (!input$meanignorecol) {
        
           if (input$Mean=="Mean") {
             if(input$meanlines&input$pointsizein != 'None')           
  p <- p + 
      stat_sum_single(mean, geom = "line")
              if(input$meanlines&input$pointsizein == 'None')           
  p <- p + 
      stat_sum_single(mean, geom = "line",size=input$meanlinesize)
        
  
                  if(input$meanpoints)           
p <- p + 
      stat_sum_single(mean, geom = "point")
             
           }
   
           if (input$Mean=="Mean (95% CI)"){
             p <- p + 
  stat_sum_df("mean_cl_normal", geom = "errorbar",fun.args=list(conf.int=input$CI),width=input$errbar)
        if(input$meanlines&input$pointsizein != 'None')  
           p <- p + 
      stat_sum_df("mean_cl_normal", geom = "line")
                if(input$meanlines&input$pointsizein == 'None')  
           p <- p + 
      stat_sum_df("mean_cl_normal", geom = "line",size=input$meanlinesize)
   if(input$meanpoints)           
p <- p + 
      stat_sum_df("mean_cl_normal", geom = "point")
             
           }
       }


  if (input$meanignorecol) {
        meancol <- input$colmean
           if (input$Mean=="Mean") {
             if(input$meanlines&input$pointsizein != 'None')           
  p <- p + 
      stat_sum_single(mean, geom = "line",col=meancol)
             
              if(input$meanlines&input$pointsizein == 'None')           
  p <- p + 
      stat_sum_single(mean, geom = "line",col=meancol,size=input$meanlinesize)
  
                  if(input$meanpoints)           
p <- p + 
      stat_sum_single(mean, geom = "point",col=meancol)
             
           }
   
           if (input$Mean=="Mean (95% CI)"){
             p <- p + 
  stat_sum_df("mean_cl_normal", geom = "errorbar",fun.args=list(conf.int=input$CI),width=input$errbar, col=meancol)
        if(input$meanlines&input$pointsizein != 'None')  
           p <- p + 
      stat_sum_df("mean_cl_normal", geom = "line", col=meancol)
            if(input$meanlines&input$pointsizein == 'None')  
           p <- p + 
      stat_sum_df("mean_cl_normal", geom = "line", col=meancol,size=input$meanlinesize)
            
   if(input$meanpoints)           
p <- p + 
      stat_sum_df("mean_cl_normal", geom = "point", col=meancol)
             
           }
       }
}

if (input$meanignoregroup) {
if (!input$meanignorecol) {
        
           if (input$Mean=="Mean") {
             if(input$meanlines&input$pointsizein != 'None')           
  p <- p + 
      stat_sum_single(mean, geom = "line",aes(group=NULL))
             if(input$meanlines&input$pointsizein == 'None')           
  p <- p + 
      stat_sum_single(mean, geom = "line",aes(group=NULL),size=input$meanlinesize)
  
                  if(input$meanpoints)           
p <- p + 
      stat_sum_single(mean, geom = "point",aes(group=NULL))
             
           }
   
           if (input$Mean=="Mean (95% CI)"){
             p <- p + 
  stat_sum_df("mean_cl_normal", geom = "errorbar",fun.args=list(conf.int=input$CI), width=input$errbar,aes(group=NULL))
        if(input$meanlines&input$pointsizein != 'None')  
           p <- p + 
      stat_sum_df("mean_cl_normal", geom = "line",aes(group=NULL))
                if(input$meanlines&input$pointsizein == 'None')  
           p <- p + 
      stat_sum_df("mean_cl_normal", geom = "line",aes(group=NULL),size=input$meanlinesize)
   if(input$meanpoints)           
p <- p + 
      stat_sum_df("mean_cl_normal", geom = "point",aes(group=NULL))
             
           }
       }


  if (input$meanignorecol) {
        meancol <- input$colmean
           if (input$Mean=="Mean") {
             if(input$meanlines&input$pointsizein != 'None')           
  p <- p + 
      stat_sum_single(mean, geom = "line",col=meancol,aes(group=NULL))
             if(input$meanlines&input$pointsizein == 'None')           
  p <- p + 
      stat_sum_single(mean, geom = "line",col=meancol,aes(group=NULL),size=input$meanlinesize)
             
  
                  if(input$meanpoints)           
p <- p + 
      stat_sum_single(mean, geom = "point",col=meancol,aes(group=NULL))
             
           }
   
           if (input$Mean=="Mean (95% CI)"){
             p <- p + 
  stat_sum_df("mean_cl_normal", geom = "errorbar",fun.args=list(conf.int=input$CI), width=input$errbar, col=meancol, aes(group=NULL))
        if(input$meanlines&input$pointsizein != 'None')  
           p <- p + 
      stat_sum_df("mean_cl_normal", geom = "line",col=meancol,aes(group=NULL))
        if(input$meanlines&input$pointsizein == 'None')  
           p <- p + 
      stat_sum_df("mean_cl_normal", geom = "line",col=meancol,aes(group=NULL),size=input$meanlinesize)
        
   if(input$meanpoints)           
p <- p + 
      stat_sum_df("mean_cl_normal", geom = "point",col=meancol,aes(group=NULL))
             
           }
       }
}
###### Mean section  END 

###### Smoothing Section START
if(!is.null(input$Smooth) ){
familyargument <- ifelse(input$smoothmethod=="glm","binomial","gaussian") 

  if ( input$ignoregroup) {
      if (!input$ignorecol) {
      spanplot <- input$loessens
      if (input$Smooth=="Smooth")
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=F,span=spanplot,aes(group=NULL))
      
      if (input$Smooth=="Smooth and SE")
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=T,span=spanplot,aes(group=NULL))
      
      if (input$Smooth=="Smooth"& input$weightin != 'None')
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=F,span=spanplot,aes(group=NULL))+  
        aes_string(weight=input$weightin)
      
      if (input$Smooth=="Smooth and SE"& input$weightin != 'None')
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=T,span=spanplot,aes(group=NULL))+  
        aes_string(weight=input$weightin)
      }
      if (input$ignorecol) {
        spanplot <- input$loessens
        colsmooth <- input$colsmooth
      if (input$Smooth=="Smooth")
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=F,span=spanplot,col=colsmooth,aes(group=NULL))
      
      if (input$Smooth=="Smooth and SE")
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=T,span=spanplot,col=colsmooth,aes(group=NULL))
      
      if (input$Smooth=="Smooth"& input$weightin != 'None')
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=F,span=spanplot,col=colsmooth,aes(group=NULL))+  
        aes_string(weight=input$weightin)
      
      if (input$Smooth=="Smooth and SE"& input$weightin != 'None')
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=T,span=spanplot,col=colsmooth,aes(group=NULL))+  
        aes_string(weight=input$weightin)
              }
      
      }

      if ( !input$ignoregroup) {
      if (!input$ignorecol) {
      spanplot <- input$loessens
      if (input$Smooth=="Smooth")
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=F,span=spanplot)
      
      if (input$Smooth=="Smooth and SE")
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=T,span=spanplot)
      
      if (input$Smooth=="Smooth"& input$weightin != 'None')
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=F,span=spanplot)+  
        aes_string(weight=input$weightin)
      
      if (input$Smooth=="Smooth and SE"& input$weightin != 'None')
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=T,span=spanplot)+  
        aes_string(weight=input$weightin)
      }
      if (input$ignorecol) {
        spanplot <- input$loessens
        colsmooth <- input$colsmooth
      if (input$Smooth=="Smooth")
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=F,span=spanplot,col=colsmooth)
      
      if (input$Smooth=="Smooth and SE")
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=T,span=spanplot,col=colsmooth)
      
      if (input$Smooth=="Smooth"& input$weightin != 'None')
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=F,span=spanplot,col=colsmooth)+  
        aes_string(weight=input$weightin)
      
      if (input$Smooth=="Smooth and SE"& input$weightin != 'None')
        p <- p + geom_smooth(method=input$smoothmethod,
                             method.args = list(family = familyargument),
                             size=1.5,se=T,span=spanplot,col=colsmooth)+  
        aes_string(weight=input$weightin)
              }
      
      }

###### smooth Section END
}
      

###### Median PI section  START  
if (!input$medianignoregroup) {
  
      if (!input$medianignorecol) {
        
           if (input$Median=="Median") {
             if(input$medianlines&input$pointsizein != 'None')           
  p <- p + 
      stat_sum_single(median, geom = "line")
             
            if(input$medianlines&input$pointsizein == 'None')           
  p <- p + 
      stat_sum_single(median, geom = "line",size=input$medianlinesize)
            
            
                  if(input$medianpoints)           
p <- p + 
      stat_sum_single(median, geom = "point")
             
           }
   
           if (input$Median=="Median/PI"&input$pointsizein == 'None'){
             p <- p + 
  stat_sum_df("median_hilow", geom = "ribbon",fun.args=list(conf.int=input$PI) ,size=input$medianlinesize,alpha=input$PItransparency,col=NA)+ 
  stat_sum_df("median_hilow", geom = "smooth",fun.args=list(conf.int=input$PI) ,size=input$medianlinesize,alpha=0)
             
             if ( input$sepguides )
           p <-   p + 
   guides(
     color = guide_legend(paste("Median"),
                          override.aes = list(shape =NA,fill=NA)),
     fill  = guide_legend(paste( 100*input$PI,"% prediction interval"),
                          override.aes = list(shape =NA ,linetype =0,alpha=0.5 )
           ) )
             
           }

                   if (input$Median=="Median/PI"&input$pointsizein != 'None'){
             p <- p + 
  stat_sum_df("median_hilow", geom = "ribbon",fun.args=list(conf.int=input$PI), alpha=input$PItransparency,col=NA)+
  stat_sum_df("median_hilow", geom = "smooth"  ,fun.args=list(conf.int=input$PI),alpha=0)
             
                      if ( input$sepguides )
           p <-   p +
   guides(
     color = guide_legend(paste("Median"),
                          override.aes = list(shape =NA,fill=NA)),
     fill  = guide_legend(paste( 100*input$PI,"% prediction interval"),
                          override.aes = list(shape =NA ,linetype =0,alpha=0.5 )
           ) )
             
           }
               }



  if (input$medianignorecol) {
        mediancol <- input$colmedian
          if (input$Median=="Median") {
             if(input$medianlines&input$pointsizein != 'None')           
  p <- p + 
      stat_sum_single(median, geom = "line",col=mediancol)
        
          if(input$medianlines&input$pointsizein == 'None')           
  p <- p + 
      stat_sum_single(median, geom = "line",col=mediancol,size=input$medianlinesize)
             
                  if(input$medianpoints)           
p <- p + 
      stat_sum_single(median, geom = "point",col=mediancol)
             
           }
   
           if (input$Median=="Median/PI"&input$pointsizein == 'None'){
             p <- p + 
  stat_sum_df("median_hilow", geom = "ribbon", fun.args=list(conf.int=input$PI), alpha=input$PItransparency,col=NA)+
   stat_sum_df("median_hilow", geom = "smooth", fun.args=list(conf.int=input$PI), size=input$medianlinesize,col=mediancol,alpha=0)
             
                 if ( input$sepguides )
           p <-   p +
   guides(
     color = guide_legend(paste("Median"),
                          override.aes = list(shape =NA,fill=NA)),
     fill  = guide_legend(paste( 100*input$PI,"% prediction interval"),
                          override.aes = list(shape =NA ,linetype =0,alpha=0.5 )
           ) )
           }
                 if (input$Median=="Median/PI"&input$pointsizein != 'None'){
             p <- p + 
  stat_sum_df("median_hilow", geom = "ribbon",fun.args=list(conf.int=input$PI),alpha=input$PItransparency,col=NA)+
   stat_sum_df("median_hilow", geom = "smooth",fun.args=list(conf.int=input$PI),col=mediancol,
               alpha=0)          
            
                 if ( input$sepguides )
           p <-   p +
   guides(
     color = guide_legend(paste("Median"),
                          override.aes = list(shape =NA,fill=NA)),
     fill  = guide_legend(paste( 100*input$PI,"% prediction interval"),
                          override.aes = list(shape =NA ,linetype =0,alpha=0.5 )
           ) )
           }
        
        
       }
}


if (input$medianignoregroup) {
  
      if (!input$medianignorecol) {
        
           if (input$Median=="Median") {
             if(input$medianlines&input$pointsizein != 'None')           
  p <- p + 
      stat_sum_single(median, geom = "line",aes(group=NULL))
               if(input$medianlines&input$pointsizein == 'None')           
  p <- p + 
      stat_sum_single(median, geom = "line",aes(group=NULL),size=input$medianlinesize)
               
                  if(input$medianpoints)           
p <- p + 
      stat_sum_single(median, geom = "point",aes(group=NULL))
             
           }
   
           if (input$Median=="Median/PI"&input$pointsizein == 'None'){
             p <- p + 
  stat_sum_df("median_hilow", geom = "ribbon",fun.args=list(conf.int=input$PI),aes(group=NULL),alpha=input$PItransparency,col=NA)+ 
stat_sum_df("median_hilow", geom = "smooth",fun.args=list(conf.int=input$PI),aes(group=NULL),size=input$medianlinesize,alpha=0)   
                 if ( input$sepguides )
           p <-   p +
   guides(
     color = guide_legend(paste("Median"),
                          override.aes = list(shape =NA,fill=NA)),
     fill  = guide_legend(paste( 100*input$PI,"% prediction interval"),
                          override.aes = list(shape =NA ,linetype =0,alpha=0.5 )
           ) )
           }
        
                 if (input$Median=="Median/PI"&input$pointsizein != 'None'){
             p <- p + 
  stat_sum_df("median_hilow", geom = "ribbon",fun.args=list(conf.int=input$PI),aes(group=NULL),alpha=input$PItransparency,col=NA)+ 
  stat_sum_df("median_hilow", geom = "smooth",fun.args=list(conf.int=input$PI),aes(group=NULL),alpha=0)
                 if ( input$sepguides )
           p <-   p +
   guides(
     color = guide_legend(paste("Median"),
                          override.aes = list(shape =NA,fill=NA)),
     fill  = guide_legend(paste( 100*input$PI,"% prediction interval"),
                          override.aes = list(shape =NA ,linetype =0,alpha=0.5 )
           ) )
           }
        
       }


  if (input$medianignorecol) {
        mediancol <- input$colmedian
          if (input$Median=="Median") {
             if(input$medianlines&input$pointsizein != 'None')           
  p <- p + 
      stat_sum_single(median, geom = "line",col=mediancol,aes(group=NULL))
             if(input$medianlines&input$pointsizein == 'None')           
  p <- p + 
      stat_sum_single(median, geom = "line",col=mediancol,aes(group=NULL),size=input$medianlinesize)
             
                  if(input$medianpoints)           
p <- p + 
      stat_sum_single(median, geom = "point",col=mediancol,aes(group=NULL))
             
           }
   
           if (input$Median=="Median/PI"&input$pointsizein == 'None'){
             p <- p + 
  stat_sum_df("median_hilow", geom = "ribbon",fun.args=list(conf.int=input$PI),aes(group=NULL),alpha=input$PItransparency,col=NA)+ 
  stat_sum_df("median_hilow", geom = "smooth",fun.args=list(conf.int=input$PI),col=mediancol,aes(group=NULL),size=input$medianlinesize,alpha=0)
                 if ( input$sepguides )
           p <-   p +
   guides(
     color = guide_legend(paste("Median"),
                          override.aes = list(shape =NA,fill=NA)),
     fill  = guide_legend(paste( 100*input$PI,"% prediction interval"),
                          override.aes = list(shape =NA ,linetype =0,alpha=0.5 )
           ) )
           }
               if (input$Median=="Median/PI"&input$pointsizein != 'None'){
             p <- p + 
  stat_sum_df("median_hilow", geom = "ribbon",fun.args=list(conf.int=input$PI),aes(group=NULL),alpha=input$PItransparency,col=NA)+ 
  stat_sum_df("median_hilow", geom = "smooth",fun.args=list(conf.int=input$PI),col=mediancol,aes(group=NULL),alpha=0)
             
             
             
                 if ( input$sepguides )
           p <-   p +
   guides(
     color = guide_legend(paste("Median"),
                          override.aes = list(shape =NA,fill=NA)),
     fill  = guide_legend(paste( 100*input$PI,"% prediction interval"),
                          override.aes = list(shape =NA ,linetype =0,alpha=0.5 )
           ) )
               }
        
       }
}



###### Median PI section  END


###### RQSS SECTION START  
if (!input$ignoregroupqr) {
    if (!input$ignorecolqr) {
      if (input$Tauvalue) {
        if(!input$hidedynamic){
       p <- p +  stat_quantile(method = "rqss",quantiles =input$Tau,size=1.5,
                                  linetype="solid", 
                                  formula=y ~ qss(x, constraint= input$Constraints,
                                                  lambda=input$Penalty))       
        }

    if (input$mid)
      p <- p +  stat_quantile(method = "rqss",quantiles = 0.5,size=1.5,
                              linetype="solid",
                              formula=y ~ qss(x, constraint= input$Constraints,
                                              lambda=input$Penalty))
    if (input$ninetieth)
      p <- p +  stat_quantile(method = "rqss",quantiles = 0.90,size=1,
                              linetype="dashed",
                              formula=y ~ qss(x, constraint= input$Constraints,
                                              lambda=input$Penalty))
    if (input$tenth)
      p <- p +  stat_quantile(method = "rqss",quantiles = 0.1,size=1,
                              linetype="dashed",
                              formula=y ~ qss(x, constraint= input$Constraints,
                                              lambda=input$Penalty))
    
    if (input$up)
      p <- p +  stat_quantile(method = "rqss",quantiles = 0.95,size=1,
                              linetype="dashed",
                              formula=y ~ qss(x, constraint= input$Constraints,
                                              lambda=input$Penalty))
    
    if (input$low) 
      p <- p +  stat_quantile(method = "rqss",quantiles = 0.05,size=1,
                              linetype="dashed",
                              formula=y ~ qss(x, constraint= input$Constraints,
                                              lambda=input$Penalty))
      
    
    
    }
  }
   if (input$ignorecolqr) {
    colqr <- input$colqr
    if (input$Tauvalue) {
      if(!input$hidedynamic){
        p <- p +  stat_quantile(method = "rqss",quantiles =input$Tau,size=1.5,
                                linetype="solid", col=colqr,
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty)) 
      }
      
      
      if (input$mid)
        p <- p +  stat_quantile(method = "rqss",quantiles = 0.5,size=1.5,
                                linetype="solid", col=colqr,
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      if (input$ninetieth)
        p <- p +  stat_quantile(method = "rqss",quantiles = 0.90,size=1,
                                linetype="dashed", col=colqr,
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      if (input$tenth)
        p <- p +  stat_quantile(method = "rqss",quantiles = 0.1,size=1,
                                linetype="dashed", col=colqr,
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      
      if (input$up)
        p <- p +  stat_quantile(method = "rqss",quantiles = 0.95,size=1,
                                linetype="dashed", col=colqr,
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      
      if (input$low) 
        p <- p +  stat_quantile(method = "rqss",quantiles = 0.05,size=1,
                                linetype="dashed", col=colqr,
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      
      
      
    }
  }
}


if (input$ignoregroupqr) {
  if (!input$ignorecolqr) {
   if (input$Tauvalue) {
     if(!input$hidedynamic){
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles =input$Tau,size=1.5,
                               linetype="solid",
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty)) 
     }
      
      if (input$mid)
        p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.5,size=1.5,
                                linetype="solid",
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      if (input$ninetieth)
        p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.90,size=1,
                                linetype="dashed", 
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      if (input$tenth)
        p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.1,size=1,
                                linetype="dashed",
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      
      if (input$up)
        p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.95,size=1,
                                linetype="dashed", 
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      
      if (input$low) 
        p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.05,size=1,
                                linetype="dashed", 
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
    }
  }
 if (input$ignorecolqr) {
   colqr <- input$colqr
   if (input$Tauvalue) {
     if(!input$hidedynamic){
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles =input$Tau,size=1.5,
                               linetype="solid",col=colqr,
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty))     
     }
     

     if (input$mid)
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.5,size=1.5,
                               linetype="solid", col=colqr,
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty))
     if (input$ninetieth)
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.90,size=1,
                               linetype="dashed", col=colqr,
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty))
     if (input$tenth)
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.1,size=1,
                               linetype="dashed", col=colqr,
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty))
     
     if (input$up)
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.95,size=1,
                               linetype="dashed", col=colqr,
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty))
     
     if (input$low) 
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.05,size=1,
                               linetype="dashed", col=colqr,
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty))
     
    }
  }
}


###### RQSS SECTION END

facets <- paste(input$facetrowin,'~', input$facetcolin)

         if (input$facetrowextrain !="."&input$facetrowin !="."){
facets <- paste(input$facetrowextrain ,"+", input$facetrowin, '~', input$facetcolin)
         }  
         if (input$facetrowextrain !="."&input$facetrowin =="."){
facets <- paste( input$facetrowextrain, '~', input$facetcolin)
         }  

         if (input$facetcolextrain !="."){
facets <- paste( facets, "+",input$facetcolextrain)
         }  
      if (facets != '. ~ .')
        p <- p + facet_grid(facets,scales=input$facetscalesin,space=input$facetspace)
      
if (facets != '. ~ .'&input$facetwrap) {
        # p <- p + facet_wrap(as.formula(facets),scales=input$facetscalesin,ncol=input$wrapncol,nrow=input$wrapnrow)
         p <- p + facet_wrap(    c(input$facetrowextrain ,input$facetrowin,input$facetcolin,input$facetcolextrain ) [
    c(input$facetrowextrain ,input$facetrowin,input$facetcolin,input$facetcolextrain )!="."]
,scales=input$facetscalesin,ncol=input$wrapncol,nrow=input$wrapnrow)

}




           if (input$logy)
      p <- p + scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                     labels = trans_format("log10", math_format(10^.x))) 
      
       if (input$logx)
      p <- p + scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
                     labels = trans_format("log10", math_format(10^.x))) 



         if (input$scientificy )
               p <- p  + 
                 scale_y_continuous(labels=comma )
      
      if (input$scientificx )
        p <- p  + 
        scale_x_continuous(labels=comma) 
      

      
       p <- p + ylab("Y variable(s)")
      if (input$ylab!="")
      p <- p + ylab(input$ylab)
      
       if (input$xlab!="")
      p <- p + xlab(input$xlab)

if (input$horizontalzero)
  p <-    p+
  geom_hline(aes(yintercept=0))
      
       if (input$customline1)
   p <-    p+
   geom_vline(xintercept=input$vline)
      
      
      if (input$customline2)
  p <-    p+
  geom_hline(yintercept=input$hline)
      
      

if (input$identityline)
 p <-    p+ geom_abline(intercept = 0, slope = 1)

      if (input$themebw)
p <-    p+
      theme_bw()
 p <-    p+
    theme(
        legend.position=input$legendposition,
        panel.background = element_rect(fill=input$backgroundcol),
        axis.title.y = element_text(size = rel(1.5)),
        axis.title.x = element_text(size = rel(1.5)),
         strip.text.x = element_text(size = 16),
        strip.text.y = element_text(size = 16)
        )
       if (input$labelguides)
 p <-    p+
    theme(legend.title=element_blank())
if (input$themeaspect)
  p <-    p+
    theme(aspect.ratio=input$aspectratio)
 
#p <- ggplotly(p)
  p


    }
    })
    
    output$plot <- renderPlot({
      plotObject()
    })
    
    
    
    
    output$plotinfo <- renderPrint({
    df<- stackdata()  
      if (is.null(df)) return(NULL)
          nearPoints( stackdata(), input$plot_click, threshold = 5, maxpoints = 5,
               addDist = TRUE) #,xvar=input$x, yvar=input$y
  })
    
    
    output$clickheader <-  renderUI({
  df <-stackdata()
    if (is.null(df)) return(NULL)
   h4("Clicked points")
     })
  
        output$brushheader <-  renderUI({
  df <-stackdata()
    if (is.null(df)) return(NULL)
     h4("Brushed points")

     })
    
        output$plot_clickedpoints <- renderTable({
      # For base graphics, we need to specify columns, though for ggplot2,
      # it's usually not necessary.
              df<- stackdata()  
      if (is.null(df)) return(NULL)
              
      res <- nearPoints(stackdata(), input$plot_click, input$x, "yvalues")
      if (nrow(res) == 0|is.null(res))
        return(NULL)
      res
    })
    output$plot_brushedpoints <- renderTable({
        df<- stackdata()  
      if (is.null(df)) return(NULL)
      res <- brushedPoints(stackdata(), input$plot_brush, input$x,"yvalues")
      if (nrow(res) == 0|is.null(res))
        return(NULL)
      res
    })
    
    
    
    
    downloadPlotType <- reactive({
      input$downloadPlotType  
    })
    
    observe({
      plotType    <- input$downloadPlotType
      plotTypePDF <- plotType == "pdf"
      plotUnit    <- ifelse(plotTypePDF, "inches", "pixels")
      plotUnitDef <- ifelse(plotTypePDF, 7, 480)
      
      updateNumericInput(
        session,
        inputId = "downloadPlotHeight",
        label = sprintf("Height (%s)", plotUnit),
        value = plotUnitDef)
      
      updateNumericInput(
        session,
        inputId = "downloadPlotWidth",
        label = sprintf("Width (%s)", plotUnit),
        value = plotUnitDef)
      
    })
    
    
    # Get the download dimensions.
    downloadPlotHeight <- reactive({
      input$downloadPlotHeight
    })
    
    downloadPlotWidth <- reactive({
      input$downloadPlotWidth
    })
    
    # Get the download file name.
    downloadPlotFileName <- reactive({
      input$downloadPlotFileName
    })
    
    # Include a downloadable file of the plot in the output list.
    output$downloadPlot <- downloadHandler(
      filename = function() {
        paste(downloadPlotFileName(), downloadPlotType(), sep=".")   
      },
      # The argument content below takes filename as a function
      # and returns what's printed to it.
      content = function(con) {
        # Gets the name of the function to use from the 
        # downloadFileType reactive element. Example:
        # returns function pdf() if downloadFileType == "pdf".
        plotFunction <- match.fun(downloadPlotType())
        plotFunction(con, width = downloadPlotWidth(), height = downloadPlotHeight())
        print(plotObject())
        dev.off(which=dev.cur())
      }
    )


  }

shinyApp(ui = ui, server = server,  options = list(height = 1000))

```
